<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic API - Template Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: #fff; padding: 30px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .sidebar { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: fit-content; }
        .content { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .template-list { list-style: none; }
        .template-item { padding: 10px; margin: 5px 0; border-radius: 4px; cursor: pointer; }
        .template-item:hover { background: #f0f0f0; }
        .template-item.active { background: #e3f2fd; }
        textarea { width: 100%; min-height: 400px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 14px; }
        .actions { margin-top: 20px; display: flex; gap: 10px; }
        .new-template { margin-bottom: 15px; }
        .new-template input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .new-template button { width: 100%; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ Semantic API</h1>
            <p class="subtitle">Template-based Intent-driven API with Kiro CLI Integration</p>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <h2 style="margin-bottom: 15px;">Templates</h2>
                <div class="new-template">
                    <input type="text" id="newTemplateName" placeholder="GET-example">
                    <button class="btn btn-success" onclick="createTemplate()">+ New</button>
                    <button class="btn btn-primary" onclick="showGenerateDialog()">ğŸ¤– Generate</button>
                </div>
                <ul class="template-list" id="templateList"></ul>
            </div>

            <div class="content">
                <div id="welcomeSection">
                    <h2>ğŸš€ Semantic API Template Manager</h2>
                    <p style="color:#666;margin:20px 0">Template-based Intent-driven API with Kiro CLI Integration</p>
                    
                    <h3 style="margin-top:30px">ì‹œì‘í•˜ê¸°</h3>
                    <ol style="line-height:2;margin-left:20px">
                        <li>ì™¼ìª½ì—ì„œ í…œí”Œë¦¿ì„ ì„ íƒí•˜ì—¬ í¸ì§‘</li>
                        <li><strong>+ New</strong> ë²„íŠ¼ìœ¼ë¡œ ìƒˆ í…œí”Œë¦¿ ìƒì„±</li>
                        <li><strong>ğŸ¤– Generate</strong> ë²„íŠ¼ìœ¼ë¡œ AIê°€ í…œí”Œë¦¿ ìë™ ìƒì„±</li>
                        <li><strong>Test</strong> ë²„íŠ¼ìœ¼ë¡œ API í…ŒìŠ¤íŠ¸</li>
                    </ol>
                    
                    <h3 style="margin-top:30px">í…œí”Œë¦¿ í˜•ì‹</h3>
                    <pre style="background:#f4f4f4;padding:15px;border-radius:4px;overflow-x:auto">GET-resource.md  â†’ GET /resource
POST-resource.md â†’ POST /resource</pre>
                    
                    <h3 style="margin-top:30px">API ì—”ë“œí¬ì¸íŠ¸</h3>
                    <ul style="line-height:2;margin-left:20px">
                        <li><code>GET /health</code> - ì„œë²„ ìƒíƒœ í™•ì¸</li>
                        <li><code>GET /templates</code> - í…œí”Œë¦¿ ëª©ë¡</li>
                        <li><code>GET /template/:name</code> - í…œí”Œë¦¿ ì¡°íšŒ</li>
                        <li><code>PUT /template/:name</code> - í…œí”Œë¦¿ ìƒì„±/ìˆ˜ì •</li>
                        <li><code>DELETE /template/:name</code> - í…œí”Œë¦¿ ì‚­ì œ</li>
                    </ul>
                </div>
                
                <div id="editorSection" style="display: none;">
                    <h2 id="templateTitle">Template Editor</h2>
                    <div id="templateDocs" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; line-height: 1.6;"></div>
                    <textarea id="templateEditor"></textarea>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="saveTemplate()">Save</button>
                        <button class="btn btn-danger" onclick="deleteTemplate()">Delete</button>
                        <button class="btn" onclick="testTemplate()">Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTemplate = null;
        const API_BASE = window.location.origin;

        async function loadTemplates() {
            const res = await fetch(`${API_BASE}/templates`);
            const data = await res.json();
            document.getElementById('templateList').innerHTML = data.templates.map(t => `
                <li class="template-item" data-name="${t}" onclick="selectTemplate('${t}')">${t}</li>
            `).join('');
        }

        async function selectTemplate(name) {
            const res = await fetch(`${API_BASE}/template/${name}`);
            const data = await res.text();
            currentTemplate = name;
            document.getElementById('templateTitle').textContent = name;
            document.getElementById('templateEditor').value = data;
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('editorSection').style.display = 'block';
            document.getElementById('templateDocs').innerHTML = generateTemplateDocs(name, data);
            
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.template-item[data-name="${name}"]`)?.classList.add('active');
        }

        function generateTemplateDocs(name, content) {
            const [method, ...pathParts] = name.replace('.md', '').split('-');
            const path = '/' + pathParts.join('/');
            
            const params = [...content.matchAll(/\{\{(\w+)\}\}/g)].map(m => m[1]).filter(p => p !== 'taskId');
            const uniqueParams = [...new Set(params)];
            
            const descMatch = content.match(/## Description\s*\n([\s\S]*?)\n\n##/);
            const description = descMatch ? descMatch[1].trim() : '';
            
            const testMatch = content.match(/## Test Example\s*```\s*([\s\S]*?)```/);
            const testExample = testMatch ? testMatch[1].trim() : '';
            
            const roleMatch = content.match(/\*\*YOU ARE\*\*:\s*(.+)/);
            const role = roleMatch ? roleMatch[1].trim() : 'Task executor';
            
            let docs = `<strong>ì—”ë“œí¬ì¸íŠ¸:</strong> <code>${method} ${path}</code><br>`;
            if (description) docs += `<strong>ì„¤ëª…:</strong> ${description}<br><br>`;
            docs += `<strong>ì—­í• :</strong> ${role}<br>`;
            if (uniqueParams.length > 0) {
                docs += `<strong>íŒŒë¼ë¯¸í„°:</strong> ${uniqueParams.map(p => `<code>${p}</code>`).join(', ')}<br>`;
            }
            if (testExample) {
                docs += `<br><strong>í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ:</strong><pre style="background:#f4f4f4;padding:10px;border-radius:4px;font-size:11px;overflow-x:auto;margin-top:5px">${testExample}</pre>`;
            }
            
            return docs;
        }

        async function createTemplate() {
            const name = document.getElementById('newTemplateName').value.trim();
            if (!name) return alert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
            
            let templateName = name.endsWith('.md') ? name : name + '.md';
            if (!templateName.match(/^(GET|POST|PUT|DELETE|PATCH)-[\w-]+\.md$/)) {
                return alert('í˜•ì‹: METHOD-path.md (ì˜ˆ: GET-weather.md)');
            }
            
            const template = `# ${templateName.replace('.md', '')} Template

**BASELINE**: See templates/SEMANTIC_API_GUIDELINES.md

## Description
[í…œí”Œë¦¿ ì„¤ëª…ì„ ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš”]

## ROLE ASSIGNMENT
**YOU ARE**: A task executor

## AUTHORITY & RESPONSIBILITY
**YOUR AUTHORITY**: Execute task and return result

## Parameters
- \`param1\`: Description

## Output Schema
\`\`\`json
{
  "result": "data"
}
\`\`\`

## Test Example
\`\`\`
${templateName.startsWith('GET') ? 'GET' : 'POST'} http://localhost:8082${templateName.replace(/^[A-Z]+-/, '/').replace('.md', '')}${templateName.startsWith('GET') ? '?param1=value' : '\nContent-Type: application/json\n\n{\n  "param1": "value"\n}'}
\`\`\`

## Instructions

\`\`\`bash
RESULT='{"result": "data"}'

curl -X POST http://localhost:8082/callback/{{taskId}} \\
  -H "Content-Type: application/json" \\
  -d "$RESULT"
\`\`\``;

            const res = await fetch(`${API_BASE}/template/${templateName}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'text/plain' },
                body: template
            });
            if (res.ok) {
                document.getElementById('newTemplateName').value = '';
                await loadTemplates();
                await selectTemplate(templateName);
            } else {
                alert('í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨');
            }
        }

        async function saveTemplate() {
            if (!currentTemplate) return;
            const content = document.getElementById('templateEditor').value;
            const res = await fetch(`${API_BASE}/template/${currentTemplate}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'text/plain' },
                body: content
            });
            if (res.ok) {
                alert('ì €ì¥ ì™„ë£Œ');
                await loadTemplates();
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        }

        async function deleteTemplate() {
            if (!currentTemplate || !confirm(`${currentTemplate}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const res = await fetch(`${API_BASE}/template/${currentTemplate}`, { method: 'DELETE' });
            if (res.ok) {
                document.getElementById('welcomeSection').style.display = 'block';
                document.getElementById('editorSection').style.display = 'none';
                currentTemplate = null;
                await loadTemplates();
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        }

        function testTemplate() {
            if (!currentTemplate) return;
            
            const content = document.getElementById('templateEditor').value;
            const testMatch = content.match(/## Test Example\s*```\s*([\s\S]*?)```/);
            
            if (!testMatch) {
                alert('í…œí”Œë¦¿ì— Test Exampleì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const httpRequest = testMatch[1].trim();
            const lines = httpRequest.split('\n');
            const [method, url] = lines[0].trim().split(/\s+/);
            
            if (!method || !url) {
                alert('Test Example í˜•ì‹ ì˜¤ë¥˜');
                return;
            }
            
            const urlObj = new URL(url.replace('localhost:8082', window.location.host));
            const path = urlObj.pathname + urlObj.search;
            
            if (method === 'GET') {
                const userInput = prompt('URL ì…ë ¥:', `${API_BASE}${path}`);
                if (userInput) window.open(userInput, '_blank');
            } else {
                const emptyLineIndex = lines.findIndex((l, i) => i > 0 && l.trim() === '');
                const bodyText = emptyLineIndex >= 0 ? lines.slice(emptyLineIndex + 1).join('\n').trim() : '{}';
                
                let defaultBody = {};
                try {
                    defaultBody = JSON.parse(bodyText);
                } catch (e) {
                    alert('JSON íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
                    return;
                }
                
                const dialog = document.createElement('div');
                dialog.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;width:600px;max-width:90%';
                dialog.innerHTML = `
                    <h3 style="margin-top:0">JSON Body ì…ë ¥</h3>
                    <p style="color:#666;font-size:12px;margin-bottom:10px">${method} ${API_BASE}${urlObj.pathname}</p>
                    <textarea id="jsonInput" style="width:100%;height:300px;font-family:monospace;padding:10px;border:1px solid #ddd;border-radius:4px">${JSON.stringify(defaultBody, null, 2)}</textarea>
                    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end">
                        <button onclick="this.closest('div').parentElement.remove();document.getElementById('overlay').remove()" style="padding:8px 16px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer">ì·¨ì†Œ</button>
                        <button id="submitBtn" style="padding:8px 16px;border:none;border-radius:4px;background:#007bff;color:white;cursor:pointer">ì‹¤í–‰</button>
                    </div>
                `;
                
                const overlay = document.createElement('div');
                overlay.id = 'overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999';
                
                document.body.appendChild(overlay);
                document.body.appendChild(dialog);
                
                document.getElementById('submitBtn').onclick = () => {
                    const body = document.getElementById('jsonInput').value;
                    dialog.remove();
                    overlay.remove();
                    
                    fetch(`${API_BASE}${urlObj.pathname}`, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: body
                    }).then(res => res.json()).then(data => {
                        alert('ì‘ë‹µ:\n' + JSON.stringify(data, null, 2));
                    }).catch(e => {
                        alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
                    });
                };
            }
        }

        function showGenerateDialog() {
            const dialog = document.createElement('div');
            dialog.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;width:600px;max-width:90%';
            dialog.innerHTML = `
                <h3 style="margin-top:0">ğŸ¤– í…œí”Œë¦¿ ìƒì„±</h3>
                <p style="color:#666;margin-bottom:15px">AIê°€ ì•„ì´ë””ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
                <textarea id="ideaInput" placeholder="ì˜ˆì‹œ:\n- ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” GET API\n- ì£¼ë¬¸ ë‚´ì—­ì„ ìƒì„±í•˜ëŠ” POST API\n- GitHub ì´ìŠˆë¥¼ ê°€ì ¸ì˜¤ëŠ” ì—”ë“œí¬ì¸íŠ¸" style="width:100%;height:150px;padding:10px;border:1px solid #ddd;border-radius:4px;font-family:inherit"></textarea>
                <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end">
                    <button onclick="this.closest('div').parentElement.remove();document.getElementById('overlay2').remove()" style="padding:8px 16px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer">ì·¨ì†Œ</button>
                    <button onclick="generateTemplateFromIdea()" style="padding:8px 16px;border:none;border-radius:4px;background:#007bff;color:white;cursor:pointer">ìƒì„±</button>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.id = 'overlay2';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999';
            
            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
        }

        async function generateTemplateFromIdea() {
            const idea = document.getElementById('ideaInput').value.trim();
            if (!idea) return alert('ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            
            const overlay = document.getElementById('overlay2');
            const dialog = document.querySelector('div[style*="z-index:1000"]');
            if (overlay) overlay.remove();
            if (dialog) dialog.remove();
            
            alert('ğŸ¤– AIê°€ í…œí”Œë¦¿ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...\n\n(êµ¬í˜„ ì˜ˆì •: POST /generate-template ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ)');
            
            // TODO: Call API to generate template
            // const res = await fetch(`${API_BASE}/generate-template`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ idea })
            // });
        }

        loadTemplates();
    </script>
</body>
</html>
